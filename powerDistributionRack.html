<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCaH-pJVKsCnLMOYHamxNh_XMUfj41vGvU",
        authDomain: "padsitepilot.firebaseapp.com",
        projectId: "padsitepilot",
        storageBucket: "padsitepilot.firebasestorage.app",
        messagingSenderId: "380246060537",
        appId: "1:380246060537:web:b8b92fdbc32d1a74826128",
        measurementId: "G-3H5TH08X46"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    window.addEventListener('load', function() {
        loadSubtasks('power');
        updateSubtaskTracker();
    });

    function toggleSubtaskNA(subtaskId, taskId) {
        const checkbox = document.getElementById(subtaskId);
        const taskControls = checkbox.closest('.task-controls');
        const naButton = taskControls.querySelector('.na-button');
        
        if (!naButton) {
            console.error(`N/A button not found for subtask: ${subtaskId}`);
            return;
        }
        
        naButton.classList.toggle('active');
        if (naButton.classList.contains('active')) {
            checkbox.disabled = true;
            checkbox.checked = false;
        } else {
            checkbox.disabled = false;
        }
        saveSubtasks(taskId);
        updateSubtaskTracker();
    }

    function saveSubtasks(taskId) {
        const subtasks = {
            confirmPowerSources: document.getElementById('confirmPowerSources')?.checked || false,
            confirmGenerator: document.getElementById('confirmGenerator')?.checked || false,
            locateExistingSkid: document.getElementById('locateExistingSkid')?.checked || false,
            buildRack: document.getElementById('buildRack')?.checked || false,
            installUnistrut: document.getElementById('installUnistrut')?.checked || false,
            na: {
                confirmPowerSources: document.querySelector('#confirmPowerSources')?.closest('.task-controls')?.querySelector('.na-button')?.classList.contains('active') || false,
                confirmGenerator: document.querySelector('#confirmGenerator')?.closest('.task-controls')?.querySelector('.na-button')?.classList.contains('active') || false,
                locateExistingSkid: document.querySelector('#locateExistingSkid')?.closest('.task-controls')?.querySelector('.na-button')?.classList.contains('active') || false,
                buildRack: document.querySelector('#buildRack')?.closest('.task-controls')?.querySelector('.na-button')?.classList.contains('active') || false,
                installUnistrut: document.querySelector('#installUnistrut')?.closest('.task-controls')?.querySelector('.na-button')?.classList.contains('active') || false
            }
        };
        db.collection('subtasks').doc(taskId).set(subtasks)
            .then(() => console.log('Subtasks saved for', taskId))
            .catch(error => console.error('Error saving subtasks:', error));
    }

    function loadSubtasks(taskId) {
        db.collection('subtasks').doc(taskId).get()
            .then(doc => {
                if (doc.exists) {
                    const subtasks = doc.data();
                    document.getElementById('confirmPowerSources')?.checked = subtasks.confirmPowerSources || false;
                    document.getElementById('confirmGenerator')?.checked = subtasks.confirmGenerator || false;
                    document.getElementById('locateExistingSkid')?.checked = subtasks.locateExistingSkid || false;
                    document.getElementById('buildRack')?.checked = subtasks.buildRack || false;
                    document.getElementById('installUnistrut')?.checked = subtasks.installUnistrut || false;
                    if (subtasks.na) {
                        ['confirmPowerSources', 'confirmGenerator', 'locateExistingSkid', 'buildRack', 'installUnistrut'].forEach(subtask => {
                            const naButton = document.querySelector(`#${subtask}`)?.closest('.task-controls')?.querySelector('.na-button');
                            if (subtasks.na[subtask] && naButton) naButton.classList.add('active');
                        });
                        updateSubtaskDisables();
                    }
                }
            })
            .catch(error => console.error('Error loading subtasks:', error));
    }

    function updateSubtaskDisables() {
        const subtasks = ['confirmPowerSources', 'confirmGenerator', 'locateExistingSkid', 'buildRack', 'installUnistrut'];
        subtasks.forEach(subtask => {
            const checkbox = document.getElementById(subtask);
            const naButton = checkbox?.closest('.task-controls')?.querySelector('.na-button');
            if (naButton && naButton.classList.contains('active')) {
                checkbox.disabled = true;
                checkbox.checked = false;
            } else if (checkbox) {
                checkbox.disabled = false;
            }
        });
    }

    function updateSubtaskTracker() {
        db.collection('subtasks').doc('power').get()
            .then(doc => {
                const tracker = document.getElementById('subtask-tracker');
                if (doc.exists) {
                    const subtasks = doc.data();
                    let completed = 0, pending = 0, na = 0;
                    for (let subtask in subtasks) {
                        if (subtask === 'na') continue;
                        if (subtasks.na && subtasks.na[subtask]) na++;
                        else if (subtasks[subtask]) completed++;
                        else pending++;
                    }
                    tracker.textContent = `Subtasks - Completed: ${completed}, Pending: ${pending}, N/A: ${na}`;
                } else {
                    tracker.textContent = "No subtasks saved yet.";
                }
            })
            .catch(error => console.error('Error updating subtask tracker:', error));
    }
</script>
