<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Distribution Rack Subtasks</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            color: #333; 
            background-image: url('./pump jack main.png'); /* Matches main page */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: #ffffff; /* Matches main page */
        }
        ul { list-style: none; padding: 0; }
        li { margin: 20px 0; }
        .step { font-size: 0.9em; color: #ccc; } /* Adjusted for visibility on background */
        button { padding: 5px 8px; font-size: 0.9em; background-color: #ff4444; color: white; border: none; cursor: pointer; border-radius: 3px; }
        button.active { background-color: #00cc00; }
        input[type="checkbox"] { 
            transform: scale(1.5); 
            margin-right: 10px; 
            vertical-align: middle;
        }
        .task-controls { display: flex; align-items: center; justify-content: space-between; }
        .task-left { display: flex; align-items: center; gap: 10px; }
        .subtask-tracker { 
            margin-top: 20px; 
            padding: 10px; 
            background-color: rgba(0, 0, 0, 0.3); 
            border-radius: 5px; 
            font-size: 1em; 
            color: #ffffff; 
        }
        a { text-decoration: none; color: #00ccff; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>Power Distribution Rack Subtasks</h1>
    <ul>
        <li><label><span class="task-controls"><span class="task-left"><input type="checkbox" id="confirmPowerSources"> Confirm Location of Existing Power Sources</span> <button class="na-button" onclick="toggleSubtaskNA('confirmPowerSources', 'power')">N/A</button></span></label>
            <div class="step">1. Confirm the location of existing power sources for 120/240V and 277/480V.</div>
            <div class="step">2. Look for an existing electrical panel, skid, or power distribution rack.</div>
            <div class="step">3. If the location has none of these, a generator will be used to power the location.</div>
        </li>
        <li><label><span class="task-controls"><span class="task-left"><input type="checkbox" id="confirmGenerator"> Confirm Generator Location</span> <button class="na-button" onclick="toggleSubtaskNA('confirmGenerator', 'power')">N/A</button></span></label>
            <div class="step">1. Confirm with the site manager where the generator will be placed when it arrives.</div>
            <div class="step">2. This location will be where you build the power distribution rack, installed parallel with the pipe rack.</div>
        </li>
        <li><label><span class="task-controls"><span class="task-left"><input type="checkbox" id="locateExistingSkid"> Locate Existing Electrical Skid and/or Existing Power Distribution Rack</span> <button class="na-button" onclick="toggleSubtaskNA('locateExistingSkid', 'power')">N/A</button></span></label>
            <div class="step">1. If the power distribution rack is not on location, you will need to confirm where the new rack will be built.</div>
            <div class="step">2. Route 120/240V to the location directly.</div>
        </li>
        <li><label><span class="task-controls"><span class="task-left"><input type="checkbox" id="buildRack"> Build Rack</span> <button class="na-button" onclick="toggleSubtaskNA('buildRack', 'power')">N/A</button></span></label>
            <div class="step">1. Post holes will be located 3’ from the pipe rack that runs down, 4’6” apart.</div>
            <div class="step">2. Holes will be 2’+ deep.</div>
            <div class="step">3. Use drop augers to dig holes.</div>
            <div class="step">4. Place 2” rigid conduit in each hole and cement, level poles perfectly (let dry before proceeding to the next step).</div>
        </li>
        <li><label><span class="task-controls"><span class="task-left"><input type="checkbox" id="installUnistrut"> Install Unistrut on Rack</span> <button class="na-button" onclick="toggleSubtaskNA('installUnistrut', 'power')">N/A</button></span></label>
            <div class="step">1. Use 3 pieces of Unistrut #9, cut at 5 feet long.</div>
            <div class="step">2. Mount to poles with 2½ inch exhaust clamps.</div>
        </li>
    </ul>
    <div class="subtask-tracker" id="subtask-tracker">Loading subtasks...</div>
    <a href="index.html">Back to Checklist</a>

    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCaH-pJVKsCnLMOYHamxNh_XMUfj41vGvU",
            authDomain: "padsitepilot.firebaseapp.com",
            projectId: "padsitepilot",
            storageBucket: "padsitepilot.firebasestorage.app",
            messagingSenderId: "380246060537",
            appId: "1:380246060537:web:b8b92fdbc32d1a74826128",
            measurementId: "G-3H5TH08X46"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        window.addEventListener('load', function() {
            loadSubtasks('power');
            updateSubtaskTracker();
        });

        function toggleSubtaskNA(subtaskId, taskId) {
            const checkbox = document.getElementById(subtaskId);
            const taskControls = checkbox.closest('.task-controls');
            const naButton = taskControls.querySelector('.na-button');
            
            if (!naButton) {
                console.error(`N/A button not found for subtask: ${subtaskId}`);
                return;
            }
            
            naButton.classList.toggle('active');
            if (naButton.classList.contains('active')) {
                checkbox.disabled = true;
                checkbox.checked = false;
            } else {
                checkbox.disabled = false;
            }
            saveSubtasks(taskId);
            updateSubtaskTracker();
        }

        function saveSubtasks(taskId) {
            const subtasks = {
                confirmPowerSources: document.getElementById('confirmPowerSources')?.checked || false,
                confirmGenerator: document.getElementById('confirmGenerator')?.checked || false,
                locateExistingSkid: document.getElementById('locateExistingSkid')?.checked || false,
                buildRack: document.getElementById('buildRack')?.checked || false,
                installUnistrut: document.getElementById('installUnistrut')?.checked || false,
                na: {
                    confirmPowerSources: document.querySelector('#confirmPowerSources')?.closest('.task-controls')?.querySelector('.na-button')?.classList.contains('active') || false,
                    confirmGenerator: document.querySelector('#confirmGenerator')?.closest('.task-controls')?.querySelector('.na-button')?.classList.contains('active') || false,
                    locateExistingSkid: document.querySelector('#locateExistingSkid')?.closest('.task-controls')?.querySelector('.na-button')?.classList.contains('active') || false,
                    buildRack: document.querySelector('#buildRack')?.closest('.task-controls')?.querySelector('.na-button')?.classList.contains('active') || false,
                    installUnistrut: document.querySelector('#installUnistrut')?.closest('.task-controls')?.querySelector('.na-button')?.classList.contains('active') || false
                }
            };
            db.collection('subtasks').doc(taskId).set(subtasks)
                .then(() => console.log('Subtasks saved for', taskId))
                .catch(error => console.error('Error saving subtasks:', error));
        }

        function loadSubtasks(taskId) {
            db.collection('subtasks').doc(taskId).get()
                .then(doc => {
                    if (doc.exists) {
                        const subtasks = doc.data();
                        document.getElementById('confirmPowerSources')?.checked = subtasks.confirmPowerSources || false;
                        document.getElementById('confirmGenerator')?.checked = subtasks.confirmGenerator || false;
                        document.getElementById('locateExistingSkid')?.checked = subtasks.locateExistingSkid || false;
                        document.getElementById('buildRack')?.checked = subtasks.buildRack || false;
                        document.getElementById('installUnistrut')?.checked = subtasks.installUnistrut || false;
                        if (subtasks.na) {
                            ['confirmPowerSources', 'confirmGenerator', 'locateExistingSkid', 'buildRack', 'installUnistrut'].forEach(subtask => {
                                const naButton = document.querySelector(`#${subtask}`)?.closest('.task-controls')?.querySelector('.na-button');
                                if (subtasks.na[subtask] && naButton) naButton.classList.add('active');
                            });
                            updateSubtaskDisables();
                        }
                    }
                })
                .catch(error => console.error('Error loading subtasks:', error));
        }

        function updateSubtaskDisables() {
            const subtasks = ['confirmPowerSources', 'confirmGenerator', 'locateExistingSkid', 'buildRack', 'installUnistrut'];
            subtasks.forEach(subtask => {
                const checkbox = document.getElementById(subtask);
                const naButton = checkbox?.closest('.task-controls')?.querySelector('.na-button');
                if (naButton && naButton.classList.contains('active')) {
                    checkbox.disabled = true;
                    checkbox.checked = false;
                } else if (checkbox) {
                    checkbox.disabled = false;
                }
            });
        }

        function updateSubtaskTracker() {
            db.collection('subtasks').doc('power').get()
                .then(doc => {
                    const tracker = document.getElementById('subtask-tracker');
                    if (doc.exists) {
                        const subtasks = doc.data();
                        let completed = 0, pending = 0, na = 0;
                        for (let subtask in subtasks) {
                            if (subtask === 'na') continue;
                            if (subtasks.na && subtasks.na[subtask]) na++;
                            else if (subtasks[subtask]) completed++;
                            else pending++;
                        }
                        tracker.textContent = `Subtasks - Completed: ${completed}, Pending: ${pending}, N/A: ${na}`;
                    } else {
                        tracker.textContent = "No subtasks saved yet.";
                    }
                })
                .catch(error => console.error('Error updating subtask tracker:', error));
        }
    </script>
</body>
</html>
